generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(uuid())
  clientId          String             @unique @default(cuid())
  email             String             @unique
  password          String
  name              String?
  phone             String?
  country           String?
  createdAt         DateTime           @default(now())
  emailVerified     Boolean            @default(false)
  lastLoginAt       DateTime?
  role              String             @default("user")
  status            String             @default("active")
  accounts          Account[]          @relation("accounts")
  activityLogs      ActivityLog[]      @relation("activityLogs")
  DefaultMT5Account DefaultMT5Account?
  deposits          Deposit[]          @relation("deposits")
  kyc               KYC?               @relation("kyc")
  mt5Accounts       MT5Account[]       @relation("mt5Accounts")
  RefreshToken      RefreshToken[]
  UserFavorite      UserFavorite[]
  withdrawals       Withdrawal[]       @relation("withdrawals")
  userLoginLogs     UserLoginLog[]     @relation("userLoginLogs")
  wallet            Wallet?
  walletTransactions WalletTransaction[] @relation("walletUserTransactions")
  notifications     Notification[]     @relation("notifications")
}

model KYC {
  id                  String    @id @default(uuid())
  isDocumentVerified  Boolean   @default(false)
  isAddressVerified   Boolean   @default(false)
  verificationStatus  String    @default("Pending")
  documentReference   String?
  addressReference    String?
  amlReference        String?
  documentSubmittedAt DateTime?
  addressSubmittedAt  DateTime?
  rejectionReason     String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  userId              String    @unique
  user                User      @relation("kyc", fields: [userId], references: [id])
}

model MT5Account {
  id                String              @id @default(uuid())
  accountId         String              @unique
  userId            String?
  accountType       String              @default("Live")
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  password          String?
  leverage          Int?
  nameOnAccount     String?
  package           String?
  DefaultMT5Account DefaultMT5Account[]
  deposits          Deposit[]           @relation("deposits")
  withdrawals       Withdrawal[]        @relation("withdrawals")
  user              User?               @relation("mt5Accounts", fields: [userId], references: [id])
  mt5Transactions   MT5Transaction[]    @relation("mt5Transactions")
}

model MT5Transaction {
  id            String     @id @default(uuid()) @db.VarChar
  type          String     @db.VarChar
  amount        Float
  status        String?    @db.VarChar
  paymentMethod String?    @db.VarChar
  transactionId String?    @db.VarChar
  comment       String?    @db.VarChar
  mt5AccountId  String     @db.VarChar
  createdAt     DateTime?  @default(now()) @db.Timestamptz(6)
  currency      String?    @db.VarChar
  depositId     String?    @db.VarChar
  withdrawalId  String?    @db.VarChar
  userId        String?    @db.VarChar
  processedBy   String?    @db.VarChar
  processedAt   DateTime?  @db.Timestamptz(6)
  updatedAt     DateTime?  @default(now()) @updatedAt @db.Timestamptz(6)
  mt5Account    MT5Account @relation("mt5Transactions", fields: [mt5AccountId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([depositId], map: "ix_MT5Transaction_depositId")
  @@index([mt5AccountId], map: "ix_MT5Transaction_mt5AccountId")
  @@index([status], map: "ix_MT5Transaction_status")
  @@index([type], map: "ix_MT5Transaction_type")
  @@index([userId], map: "ix_MT5Transaction_userId")
  @@index([withdrawalId], map: "ix_MT5Transaction_withdrawalId")
}

model Account {
  id          String   @id @default(uuid())
  userId      String
  accountType String
  balance     Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation("accounts", fields: [userId], references: [id])
}


model Deposit {
  id                    String        @id @default(uuid())
  userId                String
  mt5AccountId          String
  amount                Float
  currency              String        @default("USD")
  method                String
  paymentMethod         String?
  transactionHash       String?
  proofFileUrl          String?
  bankDetails           String?
  cryptoAddress         String?
  depositAddress        String?
  externalTransactionId String?
  status                String        @default("pending")
  rejectionReason       String?
  approvedBy            String?
  approvedAt            DateTime?
  rejectedAt            DateTime?
  processedAt           DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  mt5Account            MT5Account    @relation("deposits", fields: [mt5AccountId], references: [id])
  user                  User          @relation("deposits", fields: [userId], references: [id])

  @@index([userId])
  @@index([mt5AccountId])
  @@index([status])
  @@index([createdAt])
}

model Withdrawal {
  id                    String        @id @default(uuid())
  userId                String
  mt5AccountId          String?       // Optional - wallet withdrawals won't have this
  amount                Float
  method                String
  bankDetails           String?
  cryptoAddress         String?
  status                String        @default("pending")
  rejectionReason       String?
  approvedBy            String?
  approvedAt            DateTime?
  rejectedAt            DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  currency              String        @default("USD")
  externalTransactionId String?
  paymentMethod         String?
  processedAt           DateTime?
  walletAddress         String?
  user                  User          @relation("withdrawals", fields: [userId], references: [id])
  mt5Account            MT5Account?   @relation("withdrawals", fields: [mt5AccountId], references: [id])
  walletId              String?
  wallet                Wallet?       @relation(fields: [walletId], references: [id])

  @@index([userId])
  @@index([mt5AccountId])
  @@index([status])
  @@index([createdAt])
}

// New wallet models to support user wallet and transactions
model Wallet {
  id         String             @id @default(uuid())
  userId     String             @unique
  balance    Float              @default(0)
  walletNumber String?          @unique
  currency   String             @default("USD")
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  user       User               @relation(fields: [userId], references: [id])
  withdrawals Withdrawal[]
  transactions WalletTransaction[]
}

model WalletTransaction {
  id             String    @id @default(uuid())
  walletId       String
  userId         String
  type           String    // e.g., MT5_TO_WALLET, WALLET_WITHDRAWAL
  amount         Float
  status         String    @default("completed")
  description    String?
  mt5AccountId   String?
  withdrawalId   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  wallet         Wallet    @relation(fields: [walletId], references: [id])
  user           User      @relation("walletUserTransactions", fields: [userId], references: [id])

  @@index([walletId])
  @@index([userId])
  @@index([type])
  @@index([withdrawalId])
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  adminId   String
  action    String
  entity    String
  entityId  String?
  ipAddress String?
  userAgent String?
  oldValues String?
  newValues String?
  createdAt DateTime @default(now())
  admin     User     @relation("activityLogs", fields: [adminId], references: [id])
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  category    String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  permissions String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PaymentMethod {
  id              String    @id @default(uuid())
  userId          String
  // For crypto methods
  address         String?
  currency        String    @default("USDT")
  network         String    @default("TRC20")

  // Type of method: 'crypto' or 'bank'
  methodType      String    @default("crypto")

  // Bank fields (nullable for crypto methods)
  bankName        String?
  accountName     String?
  accountNumber   String?
  ifscSwiftCode   String?
  accountType     String?

  status          String    @default("pending")
  submittedAt     DateTime  @default(now())
  approvedAt      DateTime?
  approvedBy      String?
  rejectionReason String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
}

model UserRole {
  id         String   @id @default(uuid())
  userId     String
  roleId     String
  assignedAt DateTime @default(now())
  assignedBy String
}

model DefaultMT5Account {
  id           String     @id @default(uuid())
  userId       String     @unique
  mt5AccountId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  MT5Account   MT5Account @relation(fields: [mt5AccountId], references: [accountId])
  User         User       @relation(fields: [userId], references: [id])

  @@index([mt5AccountId])
}

model Instrument {
  id           String         @id
  symbol       String         @unique
  name         String?
  description  String?
  category     String
  group        String?
  digits       Int            @default(5)
  contractSize Float          @default(100000)
  minVolume    Float          @default(0.01)
  maxVolume    Float          @default(100)
  volumeStep   Float          @default(0.01)
  spread       Float          @default(0)
  isActive     Boolean        @default(true)
  tradingHours String?
  lastUpdated  DateTime
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  UserFavorite UserFavorite[]
}

model RefreshToken {
  id           String    @id @default(uuid()) @db.VarChar
  userId       String    @db.VarChar
  token        String    @unique(map: "ix_RefreshToken_token") @db.VarChar
  expiresAt    DateTime  @db.Timestamptz(6)
  createdAt    DateTime? @default(now()) @db.Timestamptz(6)
  revoked      Boolean?
  deviceName   String?   @db.VarChar
  ipAddress    String?   @db.VarChar
  userAgent    String?   @db.VarChar
  lastActivity DateTime? @default(now()) @db.Timestamptz(6)
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expiresAt], map: "ix_RefreshToken_expiresAt")
  @@index([userId], map: "ix_RefreshToken_userId")
  @@index([lastActivity], map: "ix_RefreshToken_lastActivity")
}

model UserFavorite {
  id           String     @id
  userId       String
  instrumentId String
  sortOrder    Int        @default(0)
  addedAt      DateTime   @default(now())
  Instrument   Instrument @relation(fields: [instrumentId], references: [id])
  User         User       @relation(fields: [userId], references: [id])

  @@unique([userId, instrumentId])
  @@index([instrumentId])
  @@index([userId])
}

model UserLoginLog {
  id            String   @id @default(uuid())
  userId        String
  user_agent    String?
  device        String?
  browser       String?
  success       Boolean  @default(true)
  failure_reason String?
  createdAt     DateTime @default(now())
  user          User     @relation("userLoginLogs", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Notification {
  id          String   @id @default(uuid())
  userId      String   @map("userId")
  type        String   @db.VarChar(50) // deposit, withdrawal, internal_transfer, account_creation, account_update, support_ticket_reply
  title       String   @db.VarChar(255)
  message     String   @db.Text
  isRead      Boolean  @default(false) @map("isRead")
  metadata    Json?    // Additional data like accountId, amount, etc.
  createdAt   DateTime @default(now()) @db.Timestamptz(6) @map("createdAt")
  readAt      DateTime? @db.Timestamptz(6) @map("readAt")
  user        User     @relation("notifications", fields: [userId], references: [id], onDelete: Cascade)

  @@map("Notification")
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}
